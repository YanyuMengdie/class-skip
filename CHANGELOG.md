# 更新日志

## [2026-02-18] 版本更新

### ✨ 新增功能

#### 1. 页面标记功能（重点标记）
- **7种基础标记类型**：
  - 💡 核心概念（蓝色）
  - ∫ 公式定理（紫色）
  - 📝 例题案例（绿色）
  - ⚠️ 易错点（橙色）
  - ⭐ 考试重点（红色）
  - 🔥 难点（深红）
  - ✨ 总结要点（金色）
- **自定义标记类型**：支持用户自定义标记名称
- **优先级设置**：高/中/低三个优先级
- **备注功能**：每个标记可添加最多200字备注
- **多类型标记**：一页可同时标记多个类型
- **入口位置**：Header 中上一页/下一页按钮附近的"重点"按钮
- **侧边栏展示**：
  - 标记页在缩略图右上角显示标记图标（可叠加）
  - 支持按类型筛选（如"只看考试重点"）
  - 支持按优先级筛选（如"只看高优先级"）
  - 标记页有黄色背景区分，便于快速找到

#### 2. Quiz 复习功能
- **入口**：侧边栏"页面"tab → "复习" → "Quiz"
- **功能**：
  - 选择出题数量（5/10/15/20道）
  - 逐题作答，每道题显示对/错和详细解析
  - 做完后可选择"回顾quiz"（查看全部题目）或"继续出quiz"（生成更多题目）
  - **智能去重**：继续出题时不会与已有题目重复
  - **多轮回顾**：回顾时可看到所有轮次的题目（第一次、第二次等）

#### 3. Flash Card 复习功能
- **入口**：侧边栏"页面"tab → "复习" → "Flash Card"
- **功能**：
  - **预估显示**：首先显示"根据PDF大约可整理出约X张闪卡"
  - 选择生成数量（1-50张）
  - 卡片翻面功能（点击卡片翻转）
  - 上一张/下一张导航
  - **智能去重**：再生成更多时不会与已有正面重复
  - 新生成的闪卡会追加到当前牌组

### 🐛 修复问题

#### 1. 便签格式丢失问题
- **问题**：从AI讲解拖拽文本到左侧创建便签时，格式严重混乱（公式被拆分、换行丢失）
- **原因**：拖拽时只传递了纯文本，丢失了HTML格式
- **修复**：
  - 获取选中区域的HTML内容（保留格式）
  - 清理HTML：保留必要格式（换行、粗体、斜体、代码、KaTeX公式），去除不需要的样式
  - 特别保护KaTeX数学公式，确保完整保留
  - 拖拽时同时传递`text/plain`和`text/html`，优先使用HTML格式
  - 便签渲染时使用`dangerouslySetInnerHTML`正确显示HTML

#### 2. 便签编辑内容被重置问题
- **问题**：编辑便签时，选中文字立即消失，输入/删除文字后内容立即恢复原样
- **原因**：编辑模式下使用了`dangerouslySetInnerHTML`，每次React重新渲染都会用原始内容覆盖用户输入
- **修复**：
  - 移除编辑模式下的`dangerouslySetInnerHTML`
  - 使用`useEffect`仅在进入编辑模式时初始化一次内容
  - 添加`onBlur`事件：失去焦点时自动保存
  - 添加`onKeyDown`事件：支持Cmd/Ctrl+Enter保存，Escape取消
  - 现在可以正常选中、输入、删除文字，编辑内容不会被重置

### 📦 持久化

- **本地存储**：所有新功能数据（页面标记、Quiz轮次、Flash Card牌组）都会保存到IndexedDB
- **云端同步**：已登录用户的数据会自动同步到云端会话
- **恢复功能**：重新打开文件或从云端恢复时，所有数据都会完整恢复

### 📝 技术细节

#### 新增类型定义（types.ts）
- `MarkType`: 标记类型枚举
- `MarkPriority`: 优先级枚举
- `PageMark`: 页面标记接口
- `PageMarks`: 按文件名存储的标记数据结构
- `QuizRound`: 测验轮次接口
- `FlashCard`: 闪卡接口

#### 新增服务（geminiService.ts）
- `generateQuizSet()`: 生成多道测验题（支持去重）
- `estimateFlashCardCount()`: 估算闪卡数量
- `generateFlashCards()`: 生成闪卡（支持去重）

#### 新增组件
- `PageMarkPanel.tsx`: 页面标记面板
- `QuizReviewPanel.tsx`: Quiz复习面板
- `FlashCardReviewPanel.tsx`: Flash Card复习面板

#### 修改组件
- `Header.tsx`: 添加"重点"按钮
- `Sidebar.tsx`: 添加"复习"入口和标记页筛选功能
- `ExplanationPanel.tsx`: 优化文本选择，支持HTML格式拖拽
- `SlideViewer.tsx`: 修复便签编辑问题，优化格式显示

---

## 使用说明

### 页面标记
1. 浏览到需要标记的页面
2. 点击Header中的"重点"按钮
3. 选择标记类型（可多选）、优先级、备注
4. 保存后，该页在侧边栏会显示标记图标

### Quiz复习
1. 侧边栏"页面"tab → "复习" → "Quiz"
2. 选择出题数量，点击"出N道题"
3. 逐题作答，查看解析
4. 完成后可选择"回顾"或"继续出题"

### Flash Card复习
1. 侧边栏"页面"tab → "复习" → "Flash Card"
2. 查看预估数量
3. 选择生成数量，点击"生成N张闪卡"
4. 点击卡片翻转，使用上一张/下一张导航
5. 可随时"再生成更多"追加闪卡

### 便签功能
1. 在AI讲解中选中文本
2. 拖拽"拖拽便签"按钮到左侧slide区域
3. 双击便签进入编辑模式
4. 正常编辑（选中、输入、删除都不会被重置）
5. 点击其他地方或按Escape自动保存
